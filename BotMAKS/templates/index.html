<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>МАКС Бот</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <!-- Заголовок с иконкой -->
    <div class="header">
        <img src="{{ url_for('static', filename='mine_logo.png') }}" alt="Логотип" class="logo">
        <h1>Интерфейс бота МАКС</h1>
        <div style="position:absolute; right: 20px; top: 20px;">
            <span>Пользователь: <strong>{{ username }}</strong></span> |
            <a href="{{ url_for('logout') }}">Выйти</a>
        </div>
    </div>

    <!-- Переключение интерфейсов -->
    <div style="text-align:center;margin-bottom:20px;">
        <button class="task-btn" onclick="showChat()">Чат + Задачи</button>
        <button class="task-btn" onclick="showSettings()">Настройки</button>
    </div>

    <!-- Чат и задачи -->
    <div id="chat-section">
        <!-- Окно чата -->
        <div class="chat-box" id="chat"></div>

        <!-- Поле ввода и кнопка отправки -->
        <div style="margin-top: 20px;">
            <input type="text" id="messageInput" placeholder="Введите команду или сообщение..." style="width: 80%; padding: 10px;" />
            <button class="task-btn" onclick="sendMessage()">Отправить</button>
        </div>

        <!-- Кнопки задач -->
        <div style="text-align:center; margin-top: 20px;">
            {% for i in range(1, 11) %}
                <button class="task-btn" onclick="runTask({{ i }})">Задача {{ i }}</button>
                {% if i % 5 == 0 %}<br>{% endif %}
            {% endfor %}
            <br><br>
            <button class="task-btn" id="botToggle" onclick="toggleBot()">Включить бота</button>
        </div>
    </div>

    <!-- Настройки сервера -->
    <div id="settings-section" style="display:none;text-align:center;">
        <form action="/update_server" method="post">
            <label>Максимум сообщений в чате: <span id="maxMsgValue">{{ settings.max_messages }}</span></label><br>
            <input type="range" min="5" max="100" value="{{ settings.max_messages }}" onchange="setMaxMessages(this.value)" oninput="document.getElementById('maxMsgValue').innerText = this.value"><br><br>

            <label>IP Сервера:</label><br>
            <input type="text" name="ip" value="{{ settings.server_ip }}"><br>
            <label>Порт:</label><br>
            <input type="number" name="port" value="{{ settings.port }}"><br><br>
            <button class="task-btn">Сохранить сервер</button>
        </form>
    </div>
</div>

<script>
    let botOn = {{ 'true' if settings.bot_on else 'false' }};
    document.getElementById("botToggle").innerText = botOn ? "Выключить бота" : "Включить бота";

    function toggleBot() {
        botOn = !botOn;
        document.getElementById("botToggle").innerText = botOn ? "Выключить бота" : "Включить бота";
        fetch('/toggle_bot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({state: botOn})
        });
    }

    function runTask(id) {
        const message = `/task${id}`;
        fetch('/send_message', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: message })
        }).then(() => {
            addMessageToChat(message);
        });
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (message === '') return;

        fetch('/send_message', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: message })
        }).then(() => {
            addMessageToChat(message);
            input.value = '';
        });
    }

    function addMessageToChat(message) {
        const chat = document.getElementById('chat');
        chat.innerHTML += `<div>> ${message}</div>`;
        chat.scrollTop = chat.scrollHeight;
    }

    function loadChatHistory() {
        fetch('/get_chat_history').then(res => res.json()).then(data => {
            const chat = document.getElementById('chat');
            chat.innerHTML = '';
            data.history.forEach(msg => {
                chat.innerHTML += `<div>> ${msg}</div>`;
            });
            chat.scrollTop = chat.scrollHeight;
        });
    }

    // Автоматическое обновление чата каждые 2 секунды
    setInterval(loadChatHistory, 2000);

    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            sendMessage();
        }
    });

    function showChat() {
        document.getElementById('chat-section').style.display = 'block';
        document.getElementById('settings-section').style.display = 'none';
        loadChatHistory();
    }

    function showSettings() {
        document.getElementById('chat-section').style.display = 'none';
        document.getElementById('settings-section').style.display = 'block';
    }

    function setMaxMessages(value) {
        fetch('/set_max_messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ value: parseInt(value) })
        }).then(loadChatHistory);
    }

    window.onload = () => {
        loadChatHistory(); // Загрузить историю при открытии
    };
</script>
</body>
</html>
